<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyDay Calendar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0A192F;
            --secondary: #172A46;
            --accent: #64d8ffe2;
            --text: #CCD6F6;
            --card-bg: rgba(23, 42, 70, 0.8);
            --morning: #00cbfe8b;
            --noon: #00aeff93;
            --night: #1e8fff91;
            --weekend: rgba(23, 42, 70, 0.9);
            --weekend-text: #1E90FF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: var(--primary);
            color: var(--text);
            min-block-size: 100vh;
            overflow: hidden;
        }

        /* Authentication Pages */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
        }

        .auth-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
            width: 100%;
            max-width: 400px;
            animation: fadeIn 0.5s ease;
        }

        .auth-card h2 {
            color: var(--accent);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .input-group input {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            outline: none;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .auth-btn {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: var(--primary);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(100, 255, 218, 0.3);
        }

        .auth-link {
            display: block;
            text-align: center;
            margin-top: 1rem;
            color: var(--accent);
            text-decoration: none;
        }

        /* Main Layout */
        .main-container {
            display: none;
            min-height: 100vh;
        }

        .navbar {
            background: var(--secondary);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .logo {
            color: var(--accent);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logout-btn {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--accent);
            color: var(--primary);
        }

        .content {
            display: flex;
            padding: 1rem;
            gap: 1rem;
            height: calc(100vh - 4rem);
        }

        /* Vertical Calendar */
        .vertical-calendar {
            flex: 3;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            overflow-y: auto;
            position: relative; /* Add relative positioning */
        }

        .week-navigation {
            display: flex;
            justify-content: flex-start; /* Align to the left */
            align-items: center;
            margin-bottom: 1rem;
        }

        .week-navigation button {
            width: 40px; /* Set width to a fixed value */
            height: 40px; /* Set height to the same fixed value to make it a square */
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            background: var(--secondary);
            color: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 5px; /* Add margin between buttons */
        }

        .week-navigation button:hover {
            background: var(--accent);
            color: var(--primary);
        }

        .day-row {
            display: grid;
            grid-template-columns: 100px repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
            min-height: calc((100% - 3rem) / 7);
        }

        .time-labels {
            display: grid;
            
            align-items: center;
            
            grid-template-columns: 100px repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: bold;
            color: var(--accent);
            font-size: 1.5rem;
            
        }

        .time-labels div:nth-child(2) { color: var(--morning); }
        .time-labels div:nth-child(3) { color: var(--noon); }
        .time-labels div:nth-child(4) { color: var(--night); }

        .date-box {
            background: var(--secondary);
            border-radius: 10px;
            padding: 0.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .date-box .weekday {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .date-box .weekday:nth-child(6), .date-box .weekday:nth-child(7) {
            color: #ffc400;
        }

        .date-box .day-month {
            font-size: 1rem;
        }

        .date-box .year {
            font-size: 1rem;
            opacity: 0.4;
        }

        .time-box {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1rem;
            position: relative;
            min-height: 100px;
        }

        .time-box.morning { background: var(--morning); }
        .time-box.noon { background: var(--noon); }
        .time-box.night { background: var(--night); }

        /* Monthly Calendar & Projects */
        .side-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .monthly-calendar {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }

        .month-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between; /* Distribute items evenly */
            gap: 0.5rem;
        }

        .calendar-grid > div {
            flex: 1 1 calc(100% / 7 - 0.5rem); /* Ensure each item takes up equal space */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--secondary);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: var(--accent);
            color: var(--primary);
        }

        .calendar-day.other-month {
            opacity: 0.3; /* Make the days dimmer */
        }

        .projects-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            flex-grow: 1;
            overflow-y: auto;
        }

        .add-project-btn {
            position: absolute;
            top: -3px;
            right: 0px;
            width: 30px;
            height: 30px;
            border-radius: 8px; /* Make it a square with rounded corners */
            background: var(--accent);
            color: var(--primary);
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            cursor: pointer;
           
            transition: all 0.3s ease;
        }

        .add-project-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(100, 255, 218, 0.5);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--secondary);
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            animation: fadeIn 0.3s ease;
        }

        /* Context Menu */
        .context-menu {
            size: 150%;
            display: none;
            position: fixed;
            background: var(--secondary);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            
        }

        .context-menu-item:hover {
            background: var(--primary);
            color: var(--accent);
            border-radius: 4px;
            
        }

        /* Additional Styles */
        .current-day {
            border: 2px solid var(--accent);
        }

        .weekend {
            background: var(--weekend);
            
        }

        .weekend .weekday {
            color: var(--weekend-text);
        }

        .task-item, .event-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem;
            margin-bottom: 0.3rem;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.323);
            cursor: pointer;
            transition: all 0.3s ease;
            justify-content: space-between; /* Add this line to space out the checkbox */
            opacity: 0.99; /* Set opacity to 0.99 */
        }

        .task-item input[type="checkbox"], .event-item input[type="checkbox"] {
            margin-left: auto; /* Align checkbox to the right */
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        .task-item.completed, .event-item.completed {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .add-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: all 0.3s ease;
            background: var(--primary);
            color: var(--text);
            font-size: 1.5rem;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .time-box:hover .add-btn {
            opacity: 1;
            box-shadow: 0 0px 30px rgb(0, 23, 13);
            
        }

        .project-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text); /* Set text color */
        }

        .project-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .project-item .project-name {
            font-weight: bold; /* Make name bolder */
        }

        .project-item .project-deadline {
            color: var(--text); /* Set text color */
            opacity: 0.5;
            font-size: 0.9rem;
        }

        .error-message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .weekday {
            text-align: center;
            font-weight: bold;
            color: var(--accent);
        }

        .weekday:nth-child(6), .weekday:nth-child(7) {
            color: var(--weekend-text); /* Blue neon color for weekends */
        }

        .month-navigation button {
            width: 40px; /* Set width to a fixed value */
            height: 40px; /* Set height to the same fixed value to make it a square */
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            background: var(--secondary);
            color: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .month-navigation button:hover {
            background: var(--accent);
            color: var(--primary);
        }

        .locked {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            cursor: not-allowed;
        }

        .project-modal-container {
            display: none;
            flex-direction: column;
            gap: 1rem;
            background: var(--secondary); /* Set background color to match input fields */
            border-radius: 15px;
            padding: 1rem; /* Add padding to merge with the space of the monthly calendar and projects list */
            backdrop-filter: blur(10px);
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            width: 100%; /* Make it as wide as the side panel */
        }

        .project-modal-container .modal-content {
            background: var(--secondary); /* Match background color */
            border-radius: 15px;
            padding: 0; /* Remove padding from the content */
            width: 100%; /* Make it as wide as the side panel */
            height: 100%; /* Make it as tall as the side panel */

        }

        .project-modal-container .input-group {
            margin-bottom: 1rem; /* Add margin to space out the input fields */
        }

        .project-modal-container .input-group input,
        .project-modal-container .input-group textarea {
            background: var(--secondary); /* Match background color */
            border: none; /* Remove border */
            border-radius: 8px;
            padding: 0.8rem;
            outline: none;
            transition: all 0.3s ease;
            width: 100%; /* Make the width match */
            color: var(--text); /* Set text color */
        }

        .project-modal-container .input-group textarea {
            resize: none; /* Disable resizing */
            height: 100px; /* Set a fixed height */
        }

        .project-modal-container .input-group input:focus,
        .project-modal-container .input-group textarea:focus {
            background: var(--secondary);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .auth-btn.cancel {
            margin-top: 10px;
            background: var(--secondary);
            color: var(--accent);
        }
        
.heading-with-margin {
    margin-bottom: 15px;
    color: var(--accent);
    font-size: 1.5rem;
}

.current-day-row {
    border: 4px solid var(--secondary);
    outline: 4px solid var(--accent);
    border-radius: 12px;
}

    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="auth-container" id="loginPage">
        <div class="auth-card">
            <h2>Welcome to EasyDay</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="auth-btn">Login</button>
                <div id="loginError" class="error-message"></div>
                <a href="#" class="auth-link" id="toRegister">Create Account</a>
            </form>
        </div>
    </div>

    <!-- Register Page -->
    <div class="auth-container" id="registerPage" style="display: none;">
        <div class="auth-card">
            <h2>Create Account</h2>
            <form id="registerForm">
                <div class="input-group">
                    <label for="registerUsername">Username</label>
                    <input type="text" id="registerUsername" required>
                </div>
                <div class="input-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <button type="submit" class="auth-btn">Register</button>
                <div id="registerError" class="error-message"></div>
                <a href="#" class="auth-link" id="toLogin">Back to Login</a>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-container" id="mainPage">
        <nav class="navbar">
            <div class="logo">EasyDay</div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </nav>
        <div class="content">
            <div class="vertical-calendar">
                <div class="time-labels">
                    <div class="week-navigation">
                        <button id="prevWeek"><i class="fas fa-chevron-up"></i></button>
                        <button id="nextWeek"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div>Morning</div>
                    <div>Noon</div>
                    <div>Night</div>
                </div>
                <div id="weeklyCalendar"></div>
            </div>
            <div class="side-panel">
                <div class="monthly-calendar" id="monthlyCalendarContainer">
                    <div class="month-navigation">
                        <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="currentMonth">September 2023</h3>
                        <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid" id="monthlyCalendar"></div>
                </div>
                <div class="projects-section" id="projectsSection">
                    <div class="projects-header" style="position: relative;">
                        <h3 class="heading-with-margin">Projects</h3>
                        <button id="addProject" class="add-project-btn">+</button>
                    </div>
                    <div id="projectsList"></div>
                </div>
                <div class="project-modal-container" id="projectModalContainer">
                    <div class="modal-content">
                        <form id="projectForm">
                            <div class="input-group">
                                <label for="projectName">Name</label>
                                <input type="text" id="projectName" required>
                            </div>
                            <div class="input-group">
                                <label for="projectDeadline">Deadline</label>
                                <input type="date" id="projectDeadline" required>
                            </div>
                            <div class="input-group">
                                <label for="projectContent">Content</label>
                                <textarea id="projectContent" rows="4" required></textarea>
                            </div>
                            <button type="submit" class="auth-btn">Add</button>
                            <button type="button" class="auth-btn" onclick="closeProjectModal()">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <form id="taskForm">
                <div class="input-group">
                    <label for="itemName">Name</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="input-group">
                    <label>Type</label>
                    <select id="itemType">
                        <option value="task">Task</option>
                        <option value="event">Event</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Repeat</label>
                    <select id="itemRepeat">
                        <option value="none">No repeat</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>
                <button type="submit" class="auth-btn">Add</button>
                <button type="button" class="auth-btn cancel" onclick="closeModal('taskModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div class="modal" id="projectModal">
        <div class="modal-content">
            <form id="projectForm">
                <div class="input-group">
                    <label for="projectName">Name</label>
                    <input type="text" id="projectName" placeholder="Project Name">
                </div>
                <div class="input-group">
                    <label for="projectDeadline">Deadline</label>
                    <input type="date" id="projectDeadline" required>
                </div>
                <div class="input-group">
                    <label for="projectContent">Content</label>
                    <textarea id="projectContent" rows="4" required></textarea>
                </div>
                <button type="submit" class="auth-btn">Add</button>
                <button type="button" class="auth-btn" onclick="closeModal('projectModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="open">Open</div>
        <div class="context-menu-item" data-action="delete">Delete</div>
    </div>

    <script>
    // Constants and State Management
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const state = {
        currentUser: currentUser || { username: 'test' },
        currentWeek: new Date(),
        currentMonth: new Date(),
        selectedDate: new Date(),
        tasks: {},
        projects: [],
        draggedItem: null,
        contextTarget: null
    };

    // DOM Elements
    const elements = {
        loginPage: document.getElementById('loginPage'),
        registerPage: document.getElementById('registerPage'),
        mainPage: document.getElementById('mainPage'),
        loginForm: document.getElementById('loginForm'),
        registerForm: document.getElementById('registerForm'),
        weeklyCalendar: document.getElementById('weeklyCalendar'),
        monthlyCalendar: document.getElementById('monthlyCalendar'),
        projectsList: document.getElementById('projectsList'),
        contextMenu: document.getElementById('contextMenu'),
        taskModal: document.getElementById('taskModal'),
        projectModal: document.getElementById('projectModal'),
        taskForm: document.getElementById('taskForm'),
        projectForm: document.getElementById('projectForm'),
        itemRepeat: document.getElementById('itemRepeat')
    };

    // Utility Functions
    function formatDate(date) {
        const options = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
        const parts = new Intl.DateTimeFormat('en-GB', options).formatToParts(date);
        const weekday = parts.find(part => part.type === 'weekday').value.toUpperCase();
        const day = parts.find(part => part.type === 'day').value;
        const month = parts.find(part => part.type === 'month').value;
        const year = parts.find(part => part.type === 'year').value;
        return { weekday, day, month, year };
    }

    function getWeekDates(date) {
        const week = [];
        const current = new Date(date);
        current.setDate(current.getDate() - ((current.getDay() + 6) % 7)); // Adjust to start from Monday
        
        for (let i = 0; i < 7; i++) {
            week.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }
        return week;
    }

    function getMonthDates(date) {
        const month = [];
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        
        firstDay.setDate(firstDay.getDate() - ((firstDay.getDay() + 6) % 7)); // Adjust to start from Monday
        
        while (firstDay <= lastDay || month.length % 7 !== 0) {
            month.push(new Date(firstDay));
            firstDay.setDate(firstDay.getDate() + 1);
        }
        return month;
    }

    // Render Functions
    function renderWeeklyCalendar() {
        const weekDates = getWeekDates(state.currentWeek);
        let html = '';

        weekDates.forEach(date => {
            const dateStr = date.toISOString().split('T')[0];
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const isToday = date.toDateString() === new Date().toDateString();
            const { weekday, day, month, year } = formatDate(date);
            
            html += `
                <div class="day-row ${isWeekend ? 'weekend' : ''} ${isToday ? 'current-day-row' : ''}">
                    <div class="date-box">
                        <div class="weekday">${weekday}</div>
                        <div class="day-month">${month} ${day}</div>
                        <div class="year">${year}</div>
                    </div>
                    <div class="time-box morning" data-date="${dateStr}" data-time="morning">
                        ${renderTasks(dateStr, 'morning')}
                        <button class="add-btn" onclick="openTaskModal('${dateStr}', 'morning')">+</button>
                    </div>
                    <div class="time-box noon" data-date="${dateStr}" data-time="noon">
                        ${renderTasks(dateStr, 'noon')}
                        <button class="add-btn" onclick="openTaskModal('${dateStr}', 'noon')">+</button>
                    </div>
                    <div class="time-box night" data-date="${dateStr}" data-time="night">
                        ${renderTasks(dateStr, 'night')}
                        <button class="add-btn" onclick="openTaskModal('${dateStr}', 'night')">+</button>
                    </div>
                </div>
            `;
        });

        elements.weeklyCalendar.innerHTML = html;
        setupDragAndDrop();
    }

    function renderMonthlyCalendar() {
        const monthDates = getMonthDates(state.currentMonth);
        const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        let html = '<div class="calendar-grid">';
        
        weekdays.forEach(day => {
            html += `<div class="weekday">${day}</div>`;
        });

        monthDates.forEach(date => {
            const isCurrentMonth = date.getMonth() === state.currentMonth.getMonth();
            const isToday = date.toDateString() === new Date().toDateString();
            
            html += `
                <div class="calendar-day ${isCurrentMonth ? '' : 'other-month'} ${isToday ? 'current-day' : ''}"
                     onclick="selectDate(new Date('${date.toISOString()}'))">
                    ${date.getDate()}
                </div>
            `;
        });

        html += '</div>';
        elements.monthlyCalendar.innerHTML = html;
        document.getElementById('currentMonth').textContent = new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'long'
        }).format(state.currentMonth);
    }

    // Event Handlers
    function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        // Simulate authentication
        if (username && password) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            currentUser = { username };
            elements.loginPage.style.display = 'none';
            elements.mainPage.style.display = 'block';
            loadUserData();
        }
    }

    function handleRegister(e) {
        e.preventDefault();
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;

        // Simulate registration
        if (username && password) {
            showLoginPage();
        }
    }

    function handleLogout() {
        state.currentUser = null;
        window.location.href = 'login.html'
    }

    function openTaskModal(date, time, task = null) {
        state.selectedDate = date;
        state.selectedTime = time;
        if (task) {
            document.getElementById('itemName').value = task.name;
            document.getElementById('itemType').value = task.type;
            document.getElementById('itemRepeat').value = task.repeat;
            elements.taskForm.dataset.taskId = task.id;
            elements.itemRepeat.disabled = true;
            elements.itemRepeat.classList.add('locked');
            elements.itemRepeat.title = "Repetition cannot be edited";
        } else {
            elements.taskForm.reset();
            delete elements.taskForm.dataset.taskId;
            elements.itemRepeat.disabled = false;
            elements.itemRepeat.classList.remove('locked');
            elements.itemRepeat.title = "";
        }
        elements.taskModal.style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function handleTaskSubmit(e) {
        e.preventDefault();
        const name = document.getElementById('itemName').value;
        const type = document.getElementById('itemType').value;
        const repeat = document.getElementById('itemRepeat').value;
        const taskId = elements.taskForm.dataset.taskId;

        const task = {
            id: taskId ? parseInt(taskId) : Date.now(),
            name,
            type,
            repeat,
            date: state.selectedDate,
            time: state.selectedTime
        };

        const addTask = (task) => {
            if (!state.tasks[task.date]) {
                state.tasks[task.date] = {};
            }
            if (!state.tasks[task.date][task.time]) {
                state.tasks[task.date][task.time] = [];
            }
            state.tasks[task.date][task.time].push(task);
        };

        if (taskId) {
            // Update existing task
            const oldTask = state.tasks[state.selectedDate][state.selectedTime].find(t => t.id === task.id);
            Object.assign(oldTask, task);
        } else {
            // Add new task
            addTask(task);

            if (repeat !== 'none') {
                let currentDate = new Date(state.selectedDate);
                for (let i = 0; i < 30; i++) { // Repeat for the next 30 days/weeks
                    if (repeat === 'daily') {
                        currentDate.setDate(currentDate.getDate() + 1);
                    } else if (repeat === 'weekly') {
                        currentDate.setDate(currentDate.getDate() + 7);
                    }
                    const newTask = { ...task, id: Date.now(), date: currentDate.toISOString().split('T')[0] };
                    addTask(newTask);
                }
            }
        }

        saveUserData();
        renderWeeklyCalendar();
        closeModal('taskModal');
    }

    function handleProjectSubmit(e) {
        e.preventDefault();
        const name = document.getElementById('projectName').value;
        const deadline = document.getElementById('projectDeadline').value;
        const content = document.getElementById('projectContent').value;
        const projectId = elements.projectForm.dataset.projectId;

        if (projectId) {
            const project = state.projects.find(p => p.id === parseInt(projectId));
            project.name = name;
            project.deadline = deadline;
            project.content = content;
        } else {
            const project = {
                id: Date.now(),
                name,
                deadline,
                content
            };
            state.projects.push(project);
        }

        saveUserData();
        renderProjects();
        closeProjectModal();
    }

    // Drag and Drop Implementation
    function setupDragAndDrop() {
        const draggables = document.querySelectorAll('.task-item, .event-item');
        const dropZones = document.querySelectorAll('.time-box');

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', handleDragStart);
            draggable.addEventListener('dragend', handleDragEnd);
        });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('drop', handleDrop);
        });
    }

    function handleDragStart(e) {
        state.draggedItem = e.target;
        e.target.classList.add('dragging');
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        const dropZone = e.currentTarget;
        dropZone.classList.remove('drag-over');

        if (state.draggedItem) {
            const oldDate = state.draggedItem.dataset.date;
            const oldTime = state.draggedItem.dataset.time;
            const newDate = dropZone.dataset.date;
            const newTime = dropZone.dataset.time;

            // Update task data
            const taskId = parseInt(state.draggedItem.dataset.taskId);
            moveTask(taskId, oldDate, oldTime, newDate, newTime);
            renderWeeklyCalendar();
        }
    }

    // Data Management
    function saveUserData() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) {
            localStorage.setItem(`tasks_${currentUser.username}`, JSON.stringify(state.tasks));
            localStorage.setItem(`projects_${currentUser.username}`, JSON.stringify(state.projects));
        }
    }

    function loadUserData() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));  
        if (currentUser) {
            const tasks = localStorage.getItem(`tasks_${currentUser.username}`);
            const projects = localStorage.getItem(`projects_${currentUser.username}`);
            
            if (tasks) state.tasks = JSON.parse(tasks);
            if (projects) state.projects = JSON.parse(projects);
            
            renderWeeklyCalendar();
            renderMonthlyCalendar();
            renderProjects();
        }
    }

    // Initialize Application
    function initApp() {
        // Event Listeners
        elements.loginForm.addEventListener('submit', handleLogin);
        elements.registerForm.addEventListener('submit', handleRegister);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
        document.getElementById('prevWeek').addEventListener('click', () => {
            state.currentWeek.setDate(state.currentWeek.getDate() - 7);
            renderWeeklyCalendar();
        });
        document.getElementById('nextWeek').addEventListener('click', () => {
            state.currentWeek.setDate(state.currentWeek.getDate() + 7);
            renderWeeklyCalendar();
        });
        document.getElementById('prevMonth').addEventListener('click', () => {
            state.currentMonth.setMonth(state.currentMonth.getMonth() - 1);
            renderMonthlyCalendar();
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            state.currentMonth.setMonth(state.currentMonth.getMonth() + 1);
            renderMonthlyCalendar();
        });
        document.getElementById('addProject').addEventListener('click', openProjectModal);
        document.getElementById('projectForm').addEventListener('submit', handleProjectSubmit);

        // Initialize views
        renderWeeklyCalendar();
        renderMonthlyCalendar();
        
        // Directly show the main page
        elements.loginPage.style.display = 'none';
        elements.mainPage.style.display = 'block';
        loadUserData();
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', initApp);

    // Context Menu
    document.addEventListener('contextmenu', (e) => {
        if (e.target.closest('.task-item') || e.target.closest('.event-item') || e.target.closest('.project-item')) {
            e.preventDefault();
            const contextMenu = elements.contextMenu;
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
            state.contextTarget = e.target.closest('.task-item, .event-item, .project-item').dataset.projectId || e.target.closest('.task-item, .event-item').dataset.taskId;
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.context-menu')) {
            elements.contextMenu.style.display = 'none';
        }
    });

    elements.contextMenu.addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        if (action === 'open' && state.contextTarget) {
            const taskId = parseInt(state.contextTarget);
            const task = findTaskById(taskId);
            if (task) {
                openTaskModal(task.date, task.time, task);
            }
        } else if (action === 'delete' && state.contextTarget) {
            deleteTask(state.contextTarget);
            renderWeeklyCalendar();
        }
        elements.contextMenu.style.display = 'none';
    });

    function findTaskById(taskId) {
        for (const date in state.tasks) {
            for (const time in state.tasks[date]) {
                const task = state.tasks[date][time].find(t => t.id === taskId);
                if (task) return task;
            }
        }
        return null;
    }

    // Additional utility functions
    function moveTask(taskId, oldDate, oldTime, newDate, newTime) {
        const task = state.tasks[oldDate][oldTime].find(t => t.id === taskId);
        if (task) {
            // Remove from old position
            state.tasks[oldDate][oldTime] = state.tasks[oldDate][oldTime].filter(t => t.id !== taskId);
            
            // Add to new position
            if (!state.tasks[newDate]) state.tasks[newDate] = {};
            if (!state.tasks[newDate][newTime]) state.tasks[newDate][newTime] = [];
            state.tasks[newDate][newTime].push({...task, date: newDate, time: newTime});
            
            saveUserData();
        }
    }

    function deleteTask(taskId) {
        Object.keys(state.tasks).forEach(date => {
            Object.keys(state.tasks[date]).forEach(time => {
                state.tasks[date][time] = state.tasks[date][time].filter(task => task.id !== parseInt(taskId));
            });
        });
        saveUserData();
    }

    function renderTasks(date, time) {
        if (!state.tasks[date] || !state.tasks[date][time]) return '';
        
        return state.tasks[date][time].map(task => `
            <div class="${task.type}-item ${task.completed ? 'completed' : ''}" 
                 draggable="true"
                 data-task-id="${task.id}"
                 data-date="${date}"
                 data-time="${time}">
                <i class="fas fa-${task.type === 'task' ? 'tasks' : 'calendar'}"></i>
                <span>${task.name}</span>
                ${task.repeat !== 'none' ? `<i class="fas fa-sync-alt"></i>` : ''}
                ${task.type === 'task' ? `<input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskCompletion(${task.id}, '${date}', '${time}')">`
                :'<input type="checkbox" style="visibility: hidden;">'}
            </div>
        `).join('');
    }

    function toggleTaskCompletion(taskId, date, time) {
        const task = state.tasks[date][time].find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            saveUserData();
            renderWeeklyCalendar();
        }
    }

    function openProjectModal() {
        document.getElementById('monthlyCalendarContainer').style.display = 'none';
        document.getElementById('projectsSection').style.display = 'none';
        document.getElementById('projectModalContainer').style.display = 'flex';
    }

    function closeProjectModal() {
        document.getElementById('monthlyCalendarContainer').style.display = 'block';
        document.getElementById('projectsSection').style.display = 'block';
        document.getElementById('projectModalContainer').style.display = 'none';
    }

    function renderProjects() {
        const projectsList = document.getElementById('projectsList');
        const sortedProjects = state.projects.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
        projectsList.innerHTML = sortedProjects.map(project => `
            <div class="project-item" data-project-id="${project.id}" oncontextmenu="openProjectContextMenu(event, ${project.id})">
                <div class="project-name">${project.name}</div>
                <div class="project-deadline">Deadline: ${formatRelativeDate(project.deadline)}</div>
            </div>
        `).join('');
    }

    function openProjectContextMenu(event, projectId) {
        event.preventDefault();
        const contextMenu = elements.contextMenu;
        contextMenu.style.display = 'block';
        contextMenu.style.left = `${event.pageX}px`;
        contextMenu.style.top = `${event.pageY}px`;
        state.contextTarget = projectId;
    }

    function handleProjectContextMenuClick(action) {
        const projectId = state.contextTarget;
        if (action === 'open') {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                document.getElementById('projectName').value = project.name;
                document.getElementById('projectDeadline').value = project.deadline;
                document.getElementById('projectContent').value = project.content;
                elements.projectForm.dataset.projectId = project.id;
                openProjectModal();
            }
        } else if (action === 'delete') {
            state.projects = state.projects.filter(p => p.id !== projectId);
            saveUserData();
            renderProjects();
        }
        elements.contextMenu.style.display = 'none';
    }

    function formatRelativeDate(date) {
        const today = new Date();
        const targetDate = new Date(date);
        const diffTime = targetDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Tomorrow';
        if (diffDays < 0) return 'Passed';
        if (diffDays < 7) return targetDate.toLocaleDateString('en-GB', { weekday: 'long' });
        return `${diffDays} days`;
    }
    </script>
</body>
</html>